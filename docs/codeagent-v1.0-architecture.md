# CodeAgent 1.0 æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† CodeAgent 1.0 çš„ç³»ç»Ÿæ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬æ ¸å¿ƒç»„ä»¶ã€æ¨¡å—äº¤äº’ã€æ•°æ®æµå’ŒæŠ€æœ¯å†³ç­–ã€‚

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CodeAgent 1.0 æ¶æ„                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   GitHub    â”‚â”€â”€â”€â”€â”‚   Webhook    â”‚â”€â”€â”€â”€â”‚   Event Router  â”‚    â”‚
â”‚  â”‚   Events    â”‚    â”‚   Handler    â”‚    â”‚                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                   â”‚              â”‚
â”‚                                                   â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                 Core Engine                             â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚   Context   â”‚ â”‚   Branch    â”‚ â”‚   Interaction   â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  Enricher   â”‚ â”‚  Strategy   â”‚ â”‚    Manager      â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚   Prompt    â”‚ â”‚  Security   â”‚ â”‚     Media       â”‚  â”‚    â”‚
â”‚  â”‚  â”‚   System    â”‚ â”‚   Manager   â”‚ â”‚   Processor     â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                   â”‚                              â”‚
â”‚                                   â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚               AI Provider Layer                         â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚   Claude    â”‚ â”‚   Gemini    â”‚ â”‚    Session      â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  Provider   â”‚ â”‚  Provider   â”‚ â”‚    Manager      â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                   â”‚                              â”‚
â”‚                                   â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              Git Operations Layer                       â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ Workspace   â”‚ â”‚  Git Ops    â”‚ â”‚   Branch        â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  Manager    â”‚ â”‚  Manager    â”‚ â”‚   Manager       â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶æ„ç‰¹ç‚¹

- **äº‹ä»¶é©±åŠ¨**: åŸºäº GitHub Webhook äº‹ä»¶çš„å“åº”å¼æ¶æ„
- **æ¨¡å—åŒ–è®¾è®¡**: å„åŠŸèƒ½æ¨¡å—æ¾è€¦åˆï¼Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤
- **æ™ºèƒ½è·¯ç”±**: æ ¹æ®äº‹ä»¶ç±»å‹æ™ºèƒ½é€‰æ‹©å¤„ç†ç­–ç•¥
- **å¤šå±‚æŠ½è±¡**: æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼ŒèŒè´£åˆ†ç¦»
- **å¯æ‰©å±•æ€§**: æ”¯æŒæ–°çš„ AI æä¾›å•†å’ŒåŠŸèƒ½æ¨¡å—

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯¦è®¾

### 1. Event Routerï¼ˆäº‹ä»¶è·¯ç”±å™¨ï¼‰

#### èŒè´£
- æ¥æ”¶å’Œè§£æ GitHub Webhook äº‹ä»¶
- æ ¹æ®äº‹ä»¶ç±»å‹è·¯ç”±åˆ°ç›¸åº”çš„å¤„ç†å™¨
- äº‹ä»¶éªŒè¯å’Œå®‰å…¨æ£€æŸ¥

#### æ¥å£è®¾è®¡
```go
// internal/event/router.go
type EventRouter interface {
    Route(ctx context.Context, event *GitHubEvent) (*RouteResult, error)
    RegisterHandler(eventType EventType, handler EventHandler) error
    GetSupportedEvents() []EventType
}

type RouteResult struct {
    Handler     EventHandler
    Context     *EventContext
    Strategy    ProcessingStrategy
}

type EventHandler interface {
    CanHandle(event *GitHubEvent) bool
    Handle(ctx context.Context, event *GitHubEvent) (*HandlerResult, error)
    GetPriority() int
}
```

#### å®ç°ç»„ä»¶
- **WebhookValidator**: Webhook ç­¾åéªŒè¯
- **EventParser**: äº‹ä»¶ç±»å‹è§£æå’Œè§„èŒƒåŒ–
- **RouteSelector**: è·¯ç”±é€‰æ‹©ç®—æ³•
- **HandlerRegistry**: å¤„ç†å™¨æ³¨å†Œç®¡ç†

### 2. Context Enricherï¼ˆä¸Šä¸‹æ–‡ä¸°å¯Œå™¨ï¼‰

#### èŒè´£
- æ”¶é›†å®Œæ•´çš„ GitHub ä¸Šä¸‹æ–‡ä¿¡æ¯
- å¤„ç†è¯„è®ºã€æ–‡ä»¶ã€å›¾ç‰‡ç­‰å¤šåª’ä½“å†…å®¹
- æ„å»ºç»“æ„åŒ–çš„ä¸Šä¸‹æ–‡æ•°æ®

#### æ¶æ„è®¾è®¡
```go
// internal/context/enricher.go
type ContextEnricher interface {
    Enrich(ctx context.Context, event *GitHubEvent) (*EnrichedContext, error)
    GetRequiredPermissions() []string
}

type EnrichedContext struct {
    Event           *GitHubEvent
    Repository      *RepositoryInfo
    Issue           *EnrichedIssue
    PullRequest     *EnrichedPullRequest
    Comments        []*ProcessedComment
    ReviewComments  []*ProcessedReviewComment
    Reviews         []*ProcessedReview
    ChangedFiles    []*ChangedFileInfo
    Images          []*DownloadedImage
    Timeline        []*TimelineEvent
    Metadata        map[string]interface{}
}
```

#### ä¸°å¯Œå™¨é“¾
```
GitHubDataFetcher â†’ CommentProcessor â†’ MediaProcessor â†’ FileAnalyzer â†’ TimelineBuilder
       â†“                 â†“               â†“              â†“             â†“
   åŸºç¡€æ•°æ®è·å–        è¯„è®ºå¤„ç†        å›¾ç‰‡ä¸‹è½½       æ–‡ä»¶åˆ†æ      æ—¶é—´çº¿æ„å»º
```

#### æ ¸å¿ƒå­ç»„ä»¶

**GitHubDataFetcher**
```go
type GitHubDataFetcher struct {
    client      *github.Client
    cache       *DataCache
    rateLimiter *RateLimiter
}

// æ‰¹é‡æ•°æ®è·å–æ¥å£
func (f *GitHubDataFetcher) FetchIssueData(ctx context.Context, issue *github.Issue) (*EnrichedIssue, error)
func (f *GitHubDataFetcher) FetchPRData(ctx context.Context, pr *github.PullRequest) (*EnrichedPullRequest, error)
func (f *GitHubDataFetcher) FetchComments(ctx context.Context, number int) ([]*github.IssueComment, error)
func (f *GitHubDataFetcher) FetchReviewComments(ctx context.Context, number int) ([]*github.PullRequestComment, error)
func (f *GitHubDataFetcher) FetchChangedFiles(ctx context.Context, number int) ([]*github.CommitFile, error)
```

**CommentProcessor**
```go
type CommentProcessor struct {
    markdownParser *MarkdownParser
    codeExtractor  *CodeExtractor
    commandParser  *CommandParser
}

func (cp *CommentProcessor) ProcessComment(comment *github.IssueComment) (*ProcessedComment, error)
func (cp *CommentProcessor) ExtractCodeBlocks(content string) ([]*CodeBlock, error)
func (cp *CommentProcessor) ParseCommands(content string) ([]*Command, error)
func (cp *CommentProcessor) ExtractMentions(content string) ([]string, error)
```

**MediaProcessor**
```go
type MediaProcessor struct {
    downloader    *ImageDownloader
    storage       *LocalStorage
    transformer   *ImageTransformer
}

func (mp *MediaProcessor) ProcessImages(content string) ([]*DownloadedImage, string, error)
func (mp *MediaProcessor) DownloadImage(url string) (*DownloadedImage, error)
func (mp *MediaProcessor) ConvertToLocalPath(githubURL string) (string, error)
```

### 3. Branch Strategyï¼ˆåˆ†æ”¯ç­–ç•¥ï¼‰

#### èŒè´£
- æ ¹æ®äº‹ä»¶ç±»å‹å†³å®šåˆ†æ”¯æ“ä½œç­–ç•¥
- ç®¡ç†åˆ†æ”¯åˆ›å»ºã€åˆ‡æ¢å’Œåˆå¹¶é€»è¾‘
- å¤„ç†å†²çªå’Œå¼‚å¸¸æƒ…å†µ

#### ç­–ç•¥æ¨¡å¼è®¾è®¡
```go
// internal/branch/strategy.go
type BranchStrategy interface {
    ShouldCreateNewBranch(ctx *EnrichedContext) bool
    GetTargetBranch(ctx *EnrichedContext) string
    GetBaseBranch(ctx *EnrichedContext) string
    GenerateBranchName(ctx *EnrichedContext) string
    GetCommitStrategy() CommitStrategy
    HandleConflicts(conflicts []*GitConflict) (*ConflictResolution, error)
}

type BranchManager struct {
    strategies map[EventType]BranchStrategy
    gitOps     *GitOperations
    workspace  *WorkspaceManager
}
```

#### å…·ä½“ç­–ç•¥å®ç°

**IssueStrategy**
```go
type IssueStrategy struct {
    branchPrefix string
    baseBranch   string
}

func (s *IssueStrategy) ShouldCreateNewBranch(ctx *EnrichedContext) bool {
    return true // Issue æ€»æ˜¯åˆ›å»ºæ–°åˆ†æ”¯
}

func (s *IssueStrategy) GenerateBranchName(ctx *EnrichedContext) string {
    return fmt.Sprintf("feature/issue-%d", ctx.Issue.GetNumber())
}
```

**PullRequestStrategy**
```go
type PullRequestStrategy struct {
    allowDirectPush bool
}

func (s *PullRequestStrategy) ShouldCreateNewBranch(ctx *EnrichedContext) bool {
    // å¦‚æœ PR æ˜¯å¼€æ”¾çŠ¶æ€ï¼Œæ¨é€åˆ°ç°æœ‰åˆ†æ”¯
    return ctx.PullRequest.GetState() != "open"
}

func (s *PullRequestStrategy) GetTargetBranch(ctx *EnrichedContext) string {
    if ctx.PullRequest.GetState() == "open" {
        return ctx.PullRequest.GetHead().GetRef()
    }
    return s.GenerateBranchName(ctx)
}
```

### 4. Interaction Managerï¼ˆäº¤äº’ç®¡ç†å™¨ï¼‰

#### èŒè´£
- ç®¡ç†ä¸ç”¨æˆ·çš„å®æ—¶äº¤äº’
- æä¾›è¿›åº¦åé¦ˆå’ŒçŠ¶æ€æ›´æ–°
- å¤„ç†é”™è¯¯å±•ç¤ºå’Œç”¨æˆ·é€šçŸ¥

#### æ ¸å¿ƒè®¾è®¡
```go
// internal/interaction/manager.go
type InteractionManager struct {
    github         *github.Client
    commentManager *CommentManager
    progress       *ProgressTracker
    ui             *UIManager
}

type ProgressTracker struct {
    tasks          []*Task
    currentTask    *Task
    startTime      time.Time
    lastUpdate     time.Time
    status         ExecutionStatus
    spinner        *SpinnerState
}

type Task struct {
    ID             string
    Description    string
    Status         TaskStatus
    StartTime      time.Time
    EndTime        time.Time
    Duration       time.Duration
    SubTasks       []*Task
    Progress       float64  // 0.0 - 1.0
    Error          error
    Metadata       map[string]interface{}
}
```

#### äº¤äº’æµç¨‹
```
1. åˆ›å»ºåˆå§‹è¯„è®º â†’ 2. æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨ â†’ 3. å¼€å§‹æ‰§è¡Œ â†’ 4. å®æ—¶æ›´æ–°è¿›åº¦ â†’ 5. å®Œæˆæ€»ç»“
      â†“                    â†“                â†“             â†“               â†“
   CreateComment      ShowTaskList     ShowSpinner   UpdateProgress   FinalizeComment
```

#### UI ç»„ä»¶

**CommentManager**
```go
type CommentManager struct {
    client    *github.Client
    formatter *MarkdownFormatter
    cache     *CommentCache
}

func (cm *CommentManager) CreateComment(ctx context.Context, content string) (*github.IssueComment, error)
func (cm *CommentManager) UpdateComment(ctx context.Context, commentID int64, content string) error
func (cm *CommentManager) FormatProgress(tracker *ProgressTracker) string
func (cm *CommentManager) FormatError(err error) string
```

**UIManager**
```go
type UIManager struct {
    templates map[string]*template.Template
    spinner   *SpinnerAnimation
}

func (ui *UIManager) RenderTaskList(tasks []*Task) string
func (ui *UIManager) RenderSpinner(message string) string
func (ui *UIManager) RenderError(err error) string
func (ui *UIManager) RenderSummary(result *ExecutionResult) string
```

### 5. Prompt Systemï¼ˆæç¤ºç³»ç»Ÿï¼‰

#### èŒè´£
- æ ¹æ®äº‹ä»¶ç±»å‹å’Œä¸Šä¸‹æ–‡ç”ŸæˆåŠ¨æ€æç¤º
- ç®¡ç†æ¨¡æ¿åº“å’Œå˜é‡è§£æ
- æ”¯æŒè‡ªå®šä¹‰æ¨¡æ¿å’Œæ¡ä»¶æ¸²æŸ“

#### ç³»ç»Ÿæ¶æ„
```go
// internal/prompt/v2/system.go
type PromptSystem struct {
    engine      *TemplateEngine
    resolver    *VariableResolver
    enrichers   []ContextEnricher
    validator   *PromptValidator
}

type TemplateEngine struct {
    templates    map[EventType]map[string]*Template
    fallbacks    map[EventType]*Template
    customLoader *CustomTemplateLoader
    cache        *TemplateCache
}
```

#### æ¨¡æ¿å±‚æ¬¡ç»“æ„
```
BaseTemplate
    â”œâ”€â”€ IssueTemplate
    â”‚   â”œâ”€â”€ IssueCreatedTemplate
    â”‚   â”œâ”€â”€ IssueAssignedTemplate
    â”‚   â””â”€â”€ IssueLabeledTemplate
    â”œâ”€â”€ PullRequestTemplate
    â”‚   â”œâ”€â”€ PROpenedTemplate
    â”‚   â”œâ”€â”€ PRReviewTemplate
    â”‚   â””â”€â”€ PRCommentTemplate
    â””â”€â”€ CustomTemplate
        â”œâ”€â”€ ProjectSpecificTemplate
        â””â”€â”€ UserDefinedTemplate
```

#### å˜é‡ç³»ç»Ÿ
```go
type VariableResolver struct {
    resolvers    map[string]VariableResolverFunc
    functions    map[string]TemplateFunc
    cache        *VariableCache
}

// æ”¯æŒçš„å˜é‡ç±»å‹
type Variable struct {
    Name         string
    Type         VariableType
    Value        interface{}
    Computed     bool
    Dependencies []string
}

// å†…ç½®å˜é‡è§£æå™¨
var BuiltinResolvers = map[string]VariableResolverFunc{
    "REPOSITORY":       resolveRepository,
    "PR_NUMBER":        resolvePRNumber,
    "ISSUE_NUMBER":     resolveIssueNumber,
    "CHANGED_FILES":    resolveChangedFiles,
    "TRIGGER_COMMENT":  resolveTriggerComment,
    "TIMESTAMP":        resolveTimestamp,
    // ... æ›´å¤šå˜é‡
}
```

#### æ¨¡æ¿ç¤ºä¾‹
```go
const IssueCreatedTemplate = `
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¨‹åºå‘˜ã€‚è¯·æ ¹æ®ä»¥ä¸‹ Issue éœ€æ±‚ç”Ÿæˆä»£ç å®ç°ã€‚

## Issue ä¿¡æ¯
**ä»“åº“**: {{.REPOSITORY}}
**Issue #{{.ISSUE_NUMBER}}**: {{.ISSUE_TITLE}}

**æè¿°**:
{{.ISSUE_BODY}}

{{if .ISSUE_LABELS}}
**æ ‡ç­¾**: {{range .ISSUE_LABELS}}[{{.}}] {{end}}
{{end}}

{{if .CHANGED_FILES}}
## ç›¸å…³æ–‡ä»¶
{{range .CHANGED_FILES}}
- {{.Path}} ({{.Status}})
{{end}}
{{end}}

{{if .HAS_CUSTOM_CONFIG}}
## é¡¹ç›®é…ç½®
è¯·å‚è€ƒé¡¹ç›®çš„ CODEAGENT.md æ–‡ä»¶ä¸­çš„è‡ªå®šä¹‰é…ç½®è¦æ±‚ã€‚
{{end}}

## ä»»åŠ¡è¦æ±‚
1. åˆ†æ Issue éœ€æ±‚ï¼Œç†è§£è¦å®ç°çš„åŠŸèƒ½
2. æŸ¥çœ‹ç›¸å…³ä»£ç æ–‡ä»¶ï¼Œäº†è§£é¡¹ç›®ç»“æ„
3. ç”Ÿæˆç¬¦åˆé¡¹ç›®è§„èŒƒçš„ä»£ç å®ç°
4. æä¾›æ¸…æ™°çš„å˜æ›´è¯´æ˜

è¯·å¼€å§‹åˆ†æå’Œå®ç°...
`
```

### 6. Security Managerï¼ˆå®‰å…¨ç®¡ç†å™¨ï¼‰

#### èŒè´£
- æ‰§è¡Œç»†ç²’åº¦çš„æƒé™æ§åˆ¶
- éªŒè¯ç”¨æˆ·æ“ä½œå’Œå·¥å…·ä½¿ç”¨æƒé™
- è®°å½•å®‰å…¨å®¡è®¡æ—¥å¿—

#### å®‰å…¨æ¨¡å‹
```go
// internal/security/manager.go
type SecurityManager struct {
    policyEngine  *PolicyEngine
    permissions   *PermissionManager
    auditor       *SecurityAuditor
    rateLimiter   *RateLimiter
}

type PolicyEngine struct {
    policies     map[string]*SecurityPolicy
    evaluator    *PolicyEvaluator
    cache        *PolicyCache
}

type SecurityPolicy struct {
    ID           string
    Name         string
    Rules        []*SecurityRule
    Conditions   []*Condition
    Actions      []SecurityAction
    Priority     int
}

type SecurityRule struct {
    Resource     string           // file, command, api
    Action       string           // read, write, execute
    Effect       EffectType       // allow, deny
    Conditions   []*Condition
    RateLimit    *RateLimit
}
```

#### æƒé™éªŒè¯æµç¨‹
```
Request â†’ PolicyEngine â†’ PermissionCheck â†’ RateLimit â†’ AuditLog â†’ Allow/Deny
   â†“           â†“              â†“              â†“           â†“          â†“
ç”¨æˆ·è¯·æ±‚    ç­–ç•¥è¯„ä¼°      æƒé™æ£€æŸ¥        é™æµæ§åˆ¶     å®¡è®¡è®°å½•    ç»“æœè¿”å›
```

### 7. Media Processorï¼ˆåª’ä½“å¤„ç†å™¨ï¼‰

#### èŒè´£
- å¤„ç† GitHub è¯„è®ºä¸­çš„å›¾ç‰‡å’Œå¤šåª’ä½“å†…å®¹
- ä¸‹è½½å¹¶è½¬æ¢ä¸ºæœ¬åœ°å¯è®¿é—®è·¯å¾„
- ç®¡ç†åª’ä½“æ–‡ä»¶ç¼“å­˜å’Œæ¸…ç†

#### å¤„ç†æµç¨‹
```go
// internal/media/processor.go
type MediaProcessor struct {
    downloader   *ImageDownloader
    storage      *MediaStorage
    transformer  *ContentTransformer
    cache        *MediaCache
}

type ImageDownloader struct {
    client       *http.Client
    maxSize      int64
    allowedTypes []string
    timeout      time.Duration
}

type MediaStorage struct {
    basePath     string
    maxDiskUsage int64
    retention    time.Duration
}
```

#### æ”¯æŒçš„åª’ä½“ç±»å‹
- **å›¾ç‰‡**: PNG, JPEG, GIF, WebP, SVG
- **æ–‡æ¡£**: PDF (è½¬æ¢ä¸ºå›¾ç‰‡)
- **ä»£ç **: è¯­æ³•é«˜äº®çš„ä»£ç æˆªå›¾

## ğŸ”„ æ•°æ®æµè®¾è®¡

### ä¸»è¦æ•°æ®æµ

#### 1. äº‹ä»¶å¤„ç†æµ
```
GitHub Webhook â†’ Event Router â†’ Context Enricher â†’ Strategy Selector â†’ AI Provider â†’ Git Operations
       â†“              â†“              â†“                  â†“             â†“              â†“
   äº‹ä»¶æ¥æ”¶        äº‹ä»¶è§£æ        ä¸Šä¸‹æ–‡æ”¶é›†          ç­–ç•¥é€‰æ‹©      AI ç”Ÿæˆ       Git æ“ä½œ
```

#### 2. ç”¨æˆ·äº¤äº’æµ
```
Task Creation â†’ Progress Tracking â†’ Status Update â†’ Comment Update â†’ User Notification
      â†“               â†“               â†“              â†“               â†“
   ä»»åŠ¡åˆ›å»º        è¿›åº¦è·Ÿè¸ª        çŠ¶æ€æ›´æ–°       è¯„è®ºæ›´æ–°        ç”¨æˆ·é€šçŸ¥
```

#### 3. å®‰å…¨éªŒè¯æµ
```
User Request â†’ Permission Check â†’ Policy Evaluation â†’ Rate Limiting â†’ Audit Logging
      â†“              â†“               â†“                â†“              â†“
   ç”¨æˆ·è¯·æ±‚        æƒé™æ£€æŸ¥        ç­–ç•¥è¯„ä¼°          é™æµæ§åˆ¶       å®¡è®¡è®°å½•
```

### æ•°æ®æ¨¡å‹

#### æ ¸å¿ƒæ•°æ®ç»“æ„
```go
// GitHub äº‹ä»¶æ¨¡å‹
type GitHubEvent struct {
    ID          string                 `json:"id"`
    Type        EventType              `json:"type"`
    Action      string                 `json:"action"`
    Repository  *github.Repository     `json:"repository"`
    Sender      *github.User          `json:"sender"`
    Payload     map[string]interface{} `json:"payload"`
    ReceivedAt  time.Time             `json:"received_at"`
}

// å·¥ä½œç©ºé—´æ¨¡å‹
type Workspace struct {
    ID           string                `json:"id"`
    Path         string                `json:"path"`
    Repository   string                `json:"repository"`
    Branch       string                `json:"branch"`
    BaseBranch   string                `json:"base_branch"`
    PRNumber     int                   `json:"pr_number,omitempty"`
    IssueNumber  int                   `json:"issue_number,omitempty"`
    AIModel      string                `json:"ai_model"`
    Status       WorkspaceStatus       `json:"status"`
    CreatedAt    time.Time            `json:"created_at"`
    UpdatedAt    time.Time            `json:"updated_at"`
    ExpiresAt    time.Time            `json:"expires_at"`
    Metadata     map[string]interface{} `json:"metadata"`
}

// æ‰§è¡Œç»“æœæ¨¡å‹
type ExecutionResult struct {
    Success       bool                  `json:"success"`
    Output        string                `json:"output"`
    Error         string                `json:"error,omitempty"`
    FilesChanged  []string             `json:"files_changed"`
    CommitSHA     string               `json:"commit_sha,omitempty"`
    BranchName    string               `json:"branch_name"`
    Duration      time.Duration        `json:"duration"`
    TaskResults   []*TaskResult        `json:"task_results"`
    Metadata      map[string]interface{} `json:"metadata"`
}
```

## ğŸ”Œ æ¥å£è®¾è®¡

### æ ¸å¿ƒæ¥å£

#### EventHandler æ¥å£
```go
type EventHandler interface {
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¤„ç†è¯¥äº‹ä»¶
    CanHandle(event *GitHubEvent) bool
    
    // å¤„ç†äº‹ä»¶
    Handle(ctx context.Context, event *GitHubEvent) (*HandlerResult, error)
    
    // è·å–å¤„ç†å™¨ä¼˜å…ˆçº§
    GetPriority() int
    
    // è·å–æ‰€éœ€æƒé™
    GetRequiredPermissions() []string
}
```

#### AIProvider æ¥å£
```go
type AIProvider interface {
    // æä¾›å•†åç§°
    Name() string
    
    // ç”Ÿæˆä»£ç 
    GenerateCode(ctx context.Context, prompt string, workspace *Workspace) (*GenerationResult, error)
    
    // å¥åº·æ£€æŸ¥
    HealthCheck(ctx context.Context) error
    
    // è·å–æ”¯æŒçš„æ¨¡å‹
    GetSupportedModels() []string
    
    // é…ç½®éªŒè¯
    ValidateConfig(config map[string]interface{}) error
}
```

#### BranchStrategy æ¥å£
```go
type BranchStrategy interface {
    // æ˜¯å¦åº”è¯¥åˆ›å»ºæ–°åˆ†æ”¯
    ShouldCreateNewBranch(ctx *EnrichedContext) bool
    
    // è·å–ç›®æ ‡åˆ†æ”¯å
    GetTargetBranch(ctx *EnrichedContext) string
    
    // è·å–åŸºç¡€åˆ†æ”¯å
    GetBaseBranch(ctx *EnrichedContext) string
    
    // ç”Ÿæˆåˆ†æ”¯å
    GenerateBranchName(ctx *EnrichedContext) string
    
    // è·å–æäº¤ç­–ç•¥
    GetCommitStrategy() CommitStrategy
}
```

## ğŸ“¦ æ¨¡å—ä¾èµ–

### ä¾èµ–å…³ç³»å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   HTTP Server   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Event Router    â”‚â”€â”€â”€â”€â”‚ Security Managerâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Context Enricher â”‚â”€â”€â”€â”€â”‚ Media Processor â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Branch Strategy â”‚â”€â”€â”€â”€â”‚ Git Operations  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Prompt System   â”‚â”€â”€â”€â”€â”‚ Template Engine â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AI Provider     â”‚â”€â”€â”€â”€â”‚Session Manager  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Interaction Mgr  â”‚â”€â”€â”€â”€â”‚ Progress Trackerâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—é—´é€šä¿¡

#### åŒæ­¥é€šä¿¡
- **HTTP API**: å¤–éƒ¨ Webhook æ¥å…¥
- **Function Call**: æ¨¡å—é—´ç›´æ¥è°ƒç”¨
- **Interface**: åŸºäºæ¥å£çš„è§£è€¦è°ƒç”¨

#### å¼‚æ­¥é€šä¿¡
- **Event Bus**: å†…éƒ¨äº‹ä»¶å¹¿æ’­
- **Message Queue**: ä»»åŠ¡é˜Ÿåˆ—å¤„ç†
- **Callback**: å¼‚æ­¥ç»“æœå›è°ƒ

## ğŸ”§ æŠ€æœ¯é€‰å‹

### ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶
- **ä¸»è¯­è¨€**: Go 1.21+
- **Web æ¡†æ¶**: Ginï¼ˆHTTP æœåŠ¡ï¼‰
- **Git æ“ä½œ**: go-git + git CLI
- **GitHub API**: go-github v58
- **æ¨¡æ¿å¼•æ“**: text/template + sprig

### å­˜å‚¨å’Œç¼“å­˜
- **æœ¬åœ°å­˜å‚¨**: æ–‡ä»¶ç³»ç»Ÿï¼ˆå·¥ä½œç©ºé—´å’Œåª’ä½“æ–‡ä»¶ï¼‰
- **å†…å­˜ç¼“å­˜**: sync.Map + TTL ç®¡ç†
- **æŒä¹…åŒ–ç¼“å­˜**: BadgerDBï¼ˆå¯é€‰ï¼‰

### å®‰å…¨å’Œç›‘æ§
- **æƒé™æ§åˆ¶**: RBAC æ¨¡å‹
- **å®¡è®¡æ—¥å¿—**: ç»“æ„åŒ–æ—¥å¿— + æ–‡ä»¶è½®è½¬
- **é™æµ**: Token Bucket ç®—æ³•
- **ç›‘æ§**: Prometheus æŒ‡æ ‡

### AI é›†æˆ
- **Claude**: Anthropic API + Claude CLI
- **Gemini**: Google API + Gemini CLI
- **ä¼šè¯ç®¡ç†**: é•¿è¿æ¥ + ä¼šè¯çŠ¶æ€ç®¡ç†

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### æ€§èƒ½ç›®æ ‡
- **å“åº”æ—¶é—´**: å¹³å‡ < 30sï¼ŒP99 < 60s
- **å¹¶å‘å¤„ç†**: æ”¯æŒ 100+ å¹¶å‘è¯·æ±‚
- **å†…å­˜ä½¿ç”¨**: < 2GB å¸¸é©»å†…å­˜
- **ç£ç›˜ä½¿ç”¨**: å·¥ä½œç©ºé—´è‡ªåŠ¨æ¸…ç†ï¼Œ< 50GB

### ä¼˜åŒ–ç­–ç•¥

#### 1. ç¼“å­˜ç­–ç•¥
```go
type CacheManager struct {
    // GitHub æ•°æ®ç¼“å­˜ï¼ˆ5åˆ†é’Ÿ TTLï¼‰
    githubCache    *TTLCache
    
    // æ¨¡æ¿ç¼“å­˜ï¼ˆ1å°æ—¶ TTLï¼‰
    templateCache  *TTLCache
    
    // åª’ä½“æ–‡ä»¶ç¼“å­˜ï¼ˆ24å°æ—¶ TTLï¼‰
    mediaCache     *TTLCache
    
    // æƒé™ç¼“å­˜ï¼ˆ10åˆ†é’Ÿ TTLï¼‰
    permissionCache *TTLCache
}
```

#### 2. å¹¶å‘æ§åˆ¶
```go
type ConcurrencyManager struct {
    // å…¨å±€è¯·æ±‚é™åˆ¶
    globalSemaphore    *semaphore.Weighted
    
    // AI æä¾›å•†é™åˆ¶
    aiProviderLimits   map[string]*semaphore.Weighted
    
    // å·¥ä½œç©ºé—´é”
    workspaceLocks     *sync.Map
}
```

#### 3. å†…å­˜ç®¡ç†
- **å¯¹è±¡æ± **: å¤ç”¨é«˜é¢‘å¯¹è±¡
- **æµå¼å¤„ç†**: å¤§æ–‡ä»¶æµå¼è¯»å–
- **åƒåœ¾å›æ”¶**: å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®

## ğŸ”„ æ‰©å±•æ€§è®¾è®¡

### æ’ä»¶ç³»ç»Ÿ
```go
type Plugin interface {
    Name() string
    Version() string
    Init(config map[string]interface{}) error
    Shutdown() error
}

type EventPlugin interface {
    Plugin
    HandleEvent(ctx context.Context, event *GitHubEvent) error
}

type AIProviderPlugin interface {
    Plugin
    AIProvider
}
```

### é…ç½®ç³»ç»Ÿ
```yaml
# config.yaml
plugins:
  - name: "custom-ai-provider"
    path: "./plugins/custom-ai-provider.so"
    config:
      api_key: "${CUSTOM_AI_API_KEY}"
      
  - name: "slack-notifier"
    path: "./plugins/slack-notifier.so"
    config:
      webhook_url: "${SLACK_WEBHOOK_URL}"

extensions:
  event_handlers:
    - plugin: "custom-ai-provider"
      events: ["issues", "pull_request"]
      
  notification_handlers:
    - plugin: "slack-notifier"
      events: ["task_completed", "task_failed"]
```

## ğŸ“‹ éƒ¨ç½²æ¶æ„

### å•æœºéƒ¨ç½²
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           CodeAgent Server          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   HTTP      â”‚ â”‚   Git Workspace â”‚â”‚
â”‚  â”‚  Service    â”‚ â”‚     Manager     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚    AI       â”‚ â”‚     Media       â”‚â”‚
â”‚  â”‚ Providers   â”‚ â”‚    Storage      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é›†ç¾¤éƒ¨ç½²
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load        â”‚â”€â”€â”€â”€â”‚ CodeAgent       â”‚
â”‚ Balancer    â”‚    â”‚ Instance 1      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ CodeAgent       â”‚
                   â”‚ Instance 2      â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ Shared Storage  â”‚
                   â”‚ (NFS/Object)    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-01-26  
**ç»´æŠ¤äººå‘˜**: CodeAgent æ¶æ„å›¢é˜Ÿ